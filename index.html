<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>吉恩冰塊 訂單表單</title>
  <style>
    /* 你的原本 CSS */
    :root {
      --bd:#e5e7eb; --info:#f8fafc; --info-bd:#cbd5e1;
      --primary:#111827;
      --primary-contrast:#fff;
      --ok-bg:#d1fae5; --ok-bd:#10b981; --ok-fg:#065f46;
    }
    body { font-family: system-ui, -apple-system, "Noto Sans TC", Arial; margin:0; background:#fff; }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    h1 { font-size:28px; margin:0 0 16px; }
    h2 { font-size:20px; margin:0 0 12px; }
    .card { border:1px solid var(--bd); border-radius:14px; padding:16px; background:#fff; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    label { display:block; font-size:14px; color:#111827; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    textarea { resize:vertical; }
    .help { color:#6b7280; font-size:12px; display:block; margin-top:4px; }
    .error { color:#b42318; font-size:13px; margin-top:8px; }
    .muted { color:#6b7280; font-size:13px; }
    .mt { margin-top:20px; }
    .notice { background:var(--info); border:1px solid var(--info-bd); color:#334155; padding:10px 14px; border-radius:12px; margin:0 0 16px; }

    .row { margin:8px 0; }

    .btn, input[type="submit"], input[type="reset"], button {
      color:#111827 !important;
      -webkit-text-fill-color:#111827 !important;
      background:#fff; border:1px solid var(--bd);
      font-size:16px; line-height:1.2; border-radius:10px;
      padding:10px 14px;
      -webkit-appearance:none; appearance:none;
      cursor:pointer;
      transition: transform .02s ease, box-shadow .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary {
      background: var(--primary);
      color: var(--primary-contrast) !important;
      -webkit-text-fill-color: var(--primary-contrast) !important;
      border:1px solid var(--primary);
      box-shadow:0 6px 18px rgba(17,24,39,.15);
      font-weight:600;
    }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; box-shadow:none; }

    .seg { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .seg .opt {
      border:2px solid var(--bd); border-radius:12px;
      padding:10px 14px; cursor:pointer; user-select:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .seg .opt[aria-pressed="true"] {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(17,24,39,.12);
      font-weight:600;
    }
    .seg .opt[aria-disabled="true"] {
      opacity:.45; cursor:not-allowed;
    }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="notice">
      <b>配送時段：</b>上午 08:00–12:00；下午 15:00–17:00。<br>
      <span class="muted">（依下單時間 + 最多可預約未來 10 天，自動限制可預約的日期與時段）</span>
    </div>

    <h1>吉恩冰塊 訂單表單</h1>

    <form id="orderForm" class="card mt" autocomplete="on">
      <h2>訂購資料</h2>
      <div class="grid">
        <div>
          <label>客戶/店家名稱
            <input name="customerName" required placeholder="阿綸熱炒／小郭飲料店">
          </label>
        </div>
        <div>
          <label>外送地址
            <input name="address" required placeholder="新北市三重區○○路 1 號">
          </label>
        </div>
        <div>
          <label>電話／手機
            <input name="phone" required inputmode="tel" placeholder="0912-345-678">
          </label>
        </div>
        <div>
          <label>預定日期
            <input type="date" name="orderDate" required>
            <small class="help" id="dateHelp"></small>
          </label>
        </div>

        <div>
          <label>選擇配送時段</label>
          <div class="seg" role="group" aria-label="配送時段">
            <div id="optAM" class="opt" role="button" aria-pressed="false">上午（08:00–12:00）</div>
            <div id="optPM" class="opt" role="button" aria-pressed="false">下午（15:00–17:00）</div>
          </div>
          <div id="slotErr" class="error" style="display:none"></div>
        </div>

        <div>
          <label>訂購數量（整數）
            <input type="number" name="qty" min="1" max="10" step="1" required placeholder="例如 2">
            <small class="help">最多 10 包</small>
          </label>
        </div>

        <div>
          <label>備註
            <textarea name="note" rows="3" placeholder="（幾點有人在？或其它提醒事項）"></textarea>
          </label>
        </div>
      </div>

      <input type="hidden" name="startTime">
      <input type="hidden" name="endTime">
      <input type="hidden" name="slot">

      <div class="row mt" style="display:flex; align-items:center; gap:10px;">
        <input id="submitBtn" type="submit" value="送出" class="btn btn-primary" style="min-width:140px">
        <input id="resetBtn" type="reset" value="清空" class="btn">
        <span id="submitMsg" class="muted"></span>
      </div>
    </form>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    const LIFF_ID = "2008199393-NjOGJm4P";  // ← 請填你的正式值
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyPFJLb4cGMELLljDXB5-Pl6fEg_doulaksba1p6hHAGvqcv1WYGa3Mr7yUQoYPAYDGKw/exec";  // ← 請填你的正式 endpoint

    const AM = { key: "AM", start: "08:00", end: "12:00" };
    const PM = { key: "PM", start: "15:00", end: "17:00" };

    const $ = s => document.querySelector(s);
    const byName = n => document.querySelector(`[name="${n}"]`);

    const orderDateEl = byName("orderDate");
    const optAM = $("#optAM"), optPM = $("#optPM");
    const dateHelp = $("#dateHelp");

    function toISODate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    function addDays(d, n) {
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }

    function getToday() {
      return toISODate(new Date());
    }

    function getMaxDate(daysAhead) {
      return toISODate(addDays(new Date(), daysAhead));
    }

    function computeSlotPolicy() {
      const now = new Date();
      const hm = now.getHours() * 60 + now.getMinutes();
      const MIN_07 = 7 * 60;
      const MIN_13 = 13 * 60;

      if (hm < MIN_07) {
        // 00:00–06:59 → 當日 AM & PM 都可
        return { allowToday: true, allowAM: true, allowPM: true, note: "現在是凌晨，可預約當日任一時段" };
      }
      if (hm >= MIN_07 && hm < MIN_13) {
        // 07:00–12:59 → 當日僅 PM
        return { allowToday: true, allowAM: false, allowPM: true, note: "今天僅可預約下午（15:00–17:00）" };
      }
      // 13:00–23:59 → 當日不允許
      return { allowToday: false, allowAM: true, allowPM: true, note: "現在時間超過 13:00，今日不可預約，請選明天起配送" };
    }

    function refreshDateAndSlot() {
      const policy = computeSlotPolicy();

      const minDate = policy.allowToday ? getToday() : toISODate(addDays(new Date(), 1));
      const maxDate = getMaxDate(10);

      orderDateEl.min = minDate;
      orderDateEl.max = maxDate;

      // 若目前 value 不合法 (空值或早於 min / 晚於 max)，就自動重設為 minDate
      if (!orderDateEl.value || orderDateEl.value < minDate || orderDateEl.value > maxDate) {
        orderDateEl.value = minDate;
      }

      dateHelp.textContent = policy.note + "；可預約日期最遠至 " + maxDate;

      const sel = orderDateEl.value;
      const isToday = sel === getToday();

      const canAM = isToday ? policy.allowAM : true;
      const canPM = isToday ? policy.allowPM : true;

      // 設定按鈕狀態
      optAM.setAttribute("aria-disabled", canAM ? "false" : "true");
      optPM.setAttribute("aria-disabled", canPM ? "false" : "true");
      optAM.style.opacity = canAM ? 1 : 0.45;
      optPM.style.opacity = canPM ? 1 : 0.45;

      // 自動選時段：若 AM 可選就選 AM，否則選 PM（若可）
      if (canAM) selectSlot(AM.key);
      else if (canPM) selectSlot(PM.key);
      else selectSlot(null);
    }

    function selectSlot(slotKey) {
      const st = byName("startTime"), et = byName("endTime"), sl = byName("slot");
      if (slotKey === AM.key) {
        st.value = AM.start; et.value = AM.end; sl.value = AM.key;
        optAM.setAttribute("aria-pressed", "true");
        optPM.setAttribute("aria-pressed", "false");
      } else if (slotKey === PM.key) {
        st.value = PM.start; et.value = PM.end; sl.value = PM.key;
        optAM.setAttribute("aria-pressed", "false");
        optPM.setAttribute("aria-pressed", "true");
      } else {
        st.value = et.value = sl.value = "";
        optAM.setAttribute("aria-pressed", "false");
        optPM.setAttribute("aria-pressed", "false");
      }
    }

    optAM.addEventListener("click", () => { if (optAM.getAttribute("aria-disabled") === "false") selectSlot(AM.key); });
    optPM.addEventListener("click", () => { if (optPM.getAttribute("aria-disabled") === "false") selectSlot(PM.key); });
    orderDateEl.addEventListener("change", refreshDateAndSlot);

    async function initLiffFlow() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
          return;
        }
        // 你的 loadDefaults / profile 邏輯...
      } catch (err) {
        console.error("liff.init 失敗", err);
      }
    }

    document.getElementById("orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = $("#submitBtn"), msg = $("#submitMsg");
      msg.className = "muted"; msg.textContent = "送出中…"; btn.disabled = true;

      refreshDateAndSlot();

      if (!byName("slot").value) {
        $("#slotErr").style.display = "block";
        $("#slotErr").textContent = "請選擇可預約的時段（上午或下午）";
        btn.disabled = false;
        return;
      }

      const qtyVal = parseInt(byName("qty").value, 10);
      if (isNaN(qtyVal) || qtyVal < 1 || qtyVal > 10) {
        msg.className = "error";
        msg.textContent = "❌ 數量必須是 1～10 之間的整數";
        btn.disabled = false;
        return;
      }

      if (!liff.isLoggedIn()) {
        msg.className = "error";
        msg.textContent = "❌ LIFF 尚未就緒或未登入";
        btn.disabled = false;
        return;
      }
      const idToken = liff.getIDToken();
      if (!idToken) {
        msg.className = "error";
        msg.textContent = "❌ 取不到 ID Token";
        btn.disabled = false;
        return;
      }

      try {
        const fd = new FormData(e.target);
        const p = new URLSearchParams();
        p.set("id_token", idToken);
        ["customerName","address","phone","orderDate","startTime","endTime","qty","note","slot"]
          .forEach(k => p.set(k, (fd.get(k) || "").toString().trim()));

        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 15000);

        const res = await fetch(GAS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: p.toString(),
          signal: controller.signal
        });
        clearTimeout(timer);

        const json = await res.json().catch(_ => ({}));
        if (!res.ok || !json.ok) throw new Error(json.message || `HTTP ${res.status}`);

        // 若你有儲存 user defaults 的機制 (load / save)，也可放回來
        // ...

        msg.className = "muted"; msg.textContent = "";
        const toast = $("#toast");
        toast.textContent = `已送出 ✅ 訂單編號：${json.orderId}`;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 3200);

        e.target.reset();
        refreshDateAndSlot();
      } catch (err) {
        console.error(err);
        msg.className = "error";
        msg.textContent = "❌ " + (err.message || err);
      } finally {
        btn.disabled = false;
      }
    });

    (async function(){
      await initLiffFlow();
      refreshDateAndSlot();
    })();
  </script>
</body>
</html>

