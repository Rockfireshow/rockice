<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>吉恩冰塊 訂單表單</title>

  <style>
    :root {
      --bd:#e5e7eb; --info:#f8fafc; --info-bd:#cbd5e1;
      --primary:#111827;
      --primary-contrast:#fff;
      --ok-bg:#d1fae5; --ok-bd:#10b981; --ok-fg:#065f46;
    }
    body { font-family: system-ui, -apple-system, "Noto Sans TC", Arial; margin:0; background:#fff; }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    h1 { font-size:28px; margin:0 0 16px; }
    h2 { font-size:20px; margin:0 0 12px; }

    .card { border:1px solid var(--bd); border-radius:14px; padding:16px; background:#fff; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    label { display:block; font-size:14px; color:#111827; }
    input, textarea {
      width:100%; box-sizing:border-box; padding:10px 12px;
      border:1px solid var(--bd); border-radius:10px; background:#fff;
    }
    textarea { resize:vertical; }

    .help { color:#6b7280; font-size:12px; margin-top:4px; display:block; }
    .error { color:#b42318; font-size:13px; margin-top:6px; }
    .muted { color:#6b7280; font-size:13px; margin-left:6px; }

    .notice {
      background:var(--info); border:1px solid var(--info-bd);
      padding:10px 14px; color:#334155; border-radius:12px;
      margin-bottom:16px;
    }

    .btn {
      background:#fff; border:1px solid var(--bd); padding:10px 14px;
      border-radius:10px; cursor:pointer;
      font-size:16px;
    }
    .btn-primary {
      background:var(--primary); border-color:var(--primary);
      color:#fff; font-weight:600;
    }

    .seg { display:flex; gap:10px; margin-top:6px; }
    .opt {
      padding:10px 14px; border-radius:12px;
      border:2px solid var(--bd); cursor:pointer;
      user-select:none;
      transition:0.15s;
    }
    .opt[aria-pressed="true"] {
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(17,24,39,.12);
      font-weight:600;
    }
    .opt[aria-disabled="true"] {
      opacity:.45; pointer-events:none;
    }

    .toast {
      position:fixed; inset:auto 16px 16px 16px;
      background:var(--ok-bg); border:1px solid var(--ok-bd);
      color:var(--ok-fg); padding:12px 16px;
      border-radius:12px; font-size:14px;
      display:none;
    }
    .toast.show { display:block; animation:fadein .18s ease; }

    @keyframes fadein {
      from { opacity:0; transform:translateY(10px); }
      to { opacity:1; transform:translateY(0); }
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
<div class="wrap">

  <div class="notice">
    <b>配送時段：</b>上午 08:00–12:00；下午 15:00–17:00。
    <span class="muted">（系統會依下單時間自動限制可預約的日期與時段）</span>
  </div>

  <h1>吉恩冰塊 訂單表單</h1>

  <form id="orderForm" class="card" autocomplete="on">
    <h2>訂購資料</h2>

    <div class="grid">
      <div>
        <label>客戶/店家名稱
          <input name="customerName" required placeholder="阿綸熱炒/小郭飲料店" />
        </label>
      </div>

      <div>
        <label>外送地址
          <input name="address" required placeholder="新北市三重區○○路 1 號" />
        </label>
      </div>

      <div>
        <label>電話/手機
          <input name="phone" required inputmode="tel" placeholder="0912-345-678" />
        </label>
      </div>

      <div>
        <label>預定日期
          <input type="date" name="orderDate" required />
          <small class="help" id="dateHelp"></small>
        </label>
      </div>

      <div>
        <label>選擇配送時段</label>
        <div class="seg">
          <div id="optAM" class="opt" aria-pressed="false">上午（08:00–12:00）</div>
          <div id="optPM" class="opt" aria-pressed="false">下午（15:00–17:00）</div>
        </div>
        <div id="slotErr" class="error" style="display:none"></div>
      </div>

      <div>
        <label>訂購數量（整數）
          <input type="number" name="qty" min="1" max="10" required placeholder="例如 2" />
          <small class="help">最多 10 包</small>
        </label>
      </div>

      <div>
        <label>備註
          <textarea name="note" rows="3" placeholder="（幾點有人在? 或其他提醒）"></textarea>
        </label>
      </div>
    </div>

    <input type="hidden" name="startTime" />
    <input type="hidden" name="endTime" />
    <input type="hidden" name="slot" />

    <div style="margin-top:20px; display:flex; gap:10px; align-items:center;">
      <input id="submitBtn" type="submit" value="送出" class="btn btn-primary" style="min-width:140px;">
      <input id="resetBtn" type="reset" value="清空" class="btn">
      <span id="submitMsg" class="muted"></span>
    </div>
  </form>
</div>

<div id="toast" class="toast"></div>

<script>
const LIFF_ID = "2008199393-NjOGJm4P";
const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyPFJLb4cGMELLljDXB5-Pl6fEg_doulaksba1p6hHAGvqcv1WYGa3Mr7yUQoYPAYDGKw/exec";

const AM = { key:"AM", start:"08:00", end:"12:00" };
const PM = { key:"PM", start:"15:00", end:"17:00" };

const $ = s => document.querySelector(s);
const byName = n => document.querySelector(`[name="${n}"]`);

function toISODate(d){
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
}

function addDays(d,n){
  let x = new Date(d);
  x.setDate(x.getDate()+n);
  return x;
}

function getNowMin(){
  const now = new Date();
  return now.getHours()*60 + now.getMinutes();
}

function policyFor(dateStr){
  const nowMin = getNowMin();
  const TODAY = toISODate(new Date());
  const d = new Date(dateStr+"T00:00:00");
  const isToday = (toISODate(d) === TODAY);

  if (isToday){
    if (nowMin >= 13*60){
      return { allowAM:false, allowPM:false, note:"超過 13:00，今天不可預約" };
    }
    if (nowMin >= 7*60 && nowMin <= 12*60+59){
      return { allowAM:false, allowPM:true, note:"上午已截止，今天僅可預約下午" };
    }
    return { allowAM:true, allowPM:true, note:"今天可預約上午或下午" };
  }

  return { allowAM:true, allowPM:true, note:"可預約上午與下午" };
}

function enforceMinDate(){
  const nowMin = getNowMin();
  const today = toISODate(new Date());
  const tomorrow = toISODate(addDays(new Date(),1));

  const minDate = (nowMin>=13*60) ? tomorrow : today;
  const el = byName("orderDate");
  el.min = minDate;

  if (!el.value || el.value < minDate){
    el.value = minDate;
  }
}

const optAM = $("#optAM");
const optPM = $("#optPM");

function setDisabled(el, disabled){
  el.setAttribute("aria-disabled", disabled?"true":"false");
}

function setSlot(slot){
  const st = byName("startTime"), et = byName("endTime"), sl = byName("slot");
  if (slot === "AM"){
    st.value = AM.start; et.value = AM.end; sl.value = "AM";
    optAM.setAttribute("aria-pressed","true"); 
    optPM.setAttribute("aria-pressed","false");
  }
  else if (slot === "PM"){
    st.value = PM.start; et.value = PM.end; sl.value = "PM";
    optAM.setAttribute("aria-pressed","false"); 
    optPM.setAttribute("aria-pressed","true");
  } else {
    st.value = et.value = sl.value = "";
    optAM.setAttribute("aria-pressed","false");
    optPM.setAttribute("aria-pressed","false");
  }
}

function refreshSlotLimit(){
  const val = byName("orderDate").value;
  const pol = policyFor(val);
  $("#dateHelp").textContent = pol.note;

  setDisabled(optAM, !pol.allowAM);
  setDisabled(optPM, !pol.allowPM);
}

optAM.addEventListener("click",()=>{
  if (optAM.getAttribute("aria-disabled")==="true") return;
  setSlot("AM");
  $("#slotErr").style.display="none";
});
optPM.addEventListener("click",()=>{
  if (optPM.getAttribute("aria-disabled")==="true") return;
  setSlot("PM");
  $("#slotErr").style.display="none";
});

async function initLiff(){
  try{
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()){
      return liff.login({ redirectUri: window.location.href });
    }
    window.LIFF_READY = true;
  }catch(e){
    console.error("LIFF 初始化失敗", e);
  }
}

$("#orderForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const btn = $("#submitBtn"), msg = $("#submitMsg");
  btn.disabled = true;
  msg.textContent = "送出中…";

  refreshSlotLimit();

  if (!byName("slot").value){
    $("#slotErr").style.display="block";
    $("#slotErr").textContent="請選擇配送時段";
    btn.disabled=false;
    return;
  }

  if (!window.LIFF_READY){
    msg.textContent="❌ LIFF 尚未就緒";
    btn.disabled=false;
    return;
  }

  const idToken = liff.getIDToken();
  if (!idToken){
    msg.textContent="❌ 無法取得 ID Token";
    btn.disabled=false;
    return;
  }

  try{
    const fd = new FormData(e.target);
    const p = new URLSearchParams();
    p.set("id_token", idToken);

    ["customerName","address","phone","orderDate","startTime","endTime","qty","note","slot"]
      .forEach(k=> p.set(k, fd.get(k)||""));

    const res = await fetch(GAS_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body: p.toString()
    });

    const json = await res.json();
    if (!json.ok) throw new Error(json.message);

    msg.textContent="";
    const toast = $("#toast");
    toast.textContent = `已送出！訂單編號：${json.orderId}`;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),3000);

    e.target.reset();
    enforceMinDate();
    refreshSlotLimit();
    setSlot(null);

  }catch(err){
    msg.textContent = "❌ 發生錯誤：" + err.message;
  }

  btn.disabled = false;
});

window.addEventListener("load", async ()=>{
  await initLiff();
  enforceMinDate();
  refreshSlotLimit();
});
</script>

</body>
</html>

