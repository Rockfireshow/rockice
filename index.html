<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF Minimal + 訂單表單</title>
  <style>
    :root { --bd:#e5e7eb; }
    body { font-family: system-ui, -apple-system, "Noto Sans TC", Arial; margin: 0; background: #fff; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 28px; margin: 0 0 16px; }
    h2 { font-size: 20px; margin: 0 0 12px; }
    .card { border: 1px solid var(--bd); border-radius: 14px; padding: 16px; background: #fff; }
    .row { margin: 8px 0; }
    .pill { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    label { display:block; font-size:14px; color:#111827; }
    input, textarea, select { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    textarea { resize: vertical; }

    /* iOS / Safari：確保按鈕文字可見，移除預設外觀 */
    .btn, input[type="submit"], input[type="reset"], button {
      color:#111827 !important;
      -webkit-text-fill-color:#111827 !important;
      background:#fff;
      border:1px solid var(--bd);
      font-size:16px; line-height:1.2; border-radius:10px; padding:10px 14px;
      -webkit-appearance:none; appearance:none; cursor:pointer;
    }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .actions { display:flex; gap:10px; align-items:center; }
    .muted { color:#6b7280; font-size:13px; }
    .ok { color:#0f5132; }
    .err { color:#b42318; }
    .mt { margin-top: 20px; }
  </style>
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>LIFF Minimal</h1>

    <!-- 狀態卡片 -->
    <div class="card">
      <div class="row">狀態：<span id="status">初始化中…</span></div>
      <div class="row">顯示名稱：<span id="displayName">—</span></div>
      <div class="row">使用者 ID：<span id="userId" class="pill">—</span></div>
      <div class="row actions">
        <input id="refreshBtn" type="button" value="重新取得 Profile" class="btn" />
        <input id="logoutBtn"  type="button" value="登出" class="btn" />
        <span class="muted">請務必以 <b>LIFF URL</b> 開啟本頁，才會有 ID Token</span>
      </div>
    </div>

    <!-- 訂單表單（欄位順序與你的試算表表頭一一對齊） -->
    <form id="orderForm" class="card mt" autocomplete="on">
      <h2>訂購資料</h2>
      <div class="grid">
        <div>
          <label>客戶/店家名稱
            <input name="customerName" required placeholder="張三火鍋/小林飲料店">
          </label>
        </div>
        <div>
          <label>外送地址
            <input name="address" required placeholder="三重區○○路 1 號">
          </label>
        </div>
        <div>
          <label>電話/手機
            <input name="phone" required inputmode="tel" placeholder="0912-345-678">
          </label>
        </div>
        <div>
          <label>訂購日期
            <input type="date" name="orderDate" required>
          </label>
        </div>
        <div>
          <label>開始時間
            <input type="time" name="startTime" required>
          </label>
        </div>
        <div>
          <label>結束時間
            <input type="time" name="endTime" required>
          </label>
        </div>
        <div>
          <label>訂購數量（整數）
            <input type="number" name="qty" min="1" step="1" required placeholder="例如 2">
          </label>
        </div>
        <div>
          <label>備註
            <textarea name="note" rows="3" ></textarea>
          </label>
        </div>
      </div>
      <div class="actions mt">
        <input id="submitBtn" type="submit" value="送出" class="btn">
        <input id="resetBtn"  type="reset"  value="清空" class="btn">
        <span id="submitMsg" class="muted"></span>
      </div>
    </form>
  </div>

  <script>
    // ★ 把這個換成你的 LIFF ID（需含 openid scope，才能拿到 id_token）
    const LIFF_ID = "2008199393-AMqeEVBY";
    // ★ 你的 GAS Web App（exec）
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzOnEFXY2GND553uppqGvrApa6dmsGJiOcpXbXDdIK9X-czAKGSk9nw4LUga6A7t9As/exec";

    const $ = (s) => document.querySelector(s);
    const byName = (n) => document.querySelector(`[name="${n}"]`);

    // 用網址 ?key=value 預填（如 ?customerName=林小姐&qty=2）
    function prefillFromQuery() {
      const q = new URLSearchParams(location.search);
      ["customerName","address","phone","orderDate","startTime","endTime","qty","note"]
        .forEach(k => { const v = q.get(k); if (v !== null) byName(k).value = decodeURIComponent(v); });
    }

    async function ensureLogin() {
      if (!liff.isLoggedIn()) { liff.login(); return false; }
      return true;
    }

    async function loadProfile() {
      try {
        const p = await liff.getProfile();
        $("#displayName").textContent = p.displayName || "—";
        $("#userId").textContent      = p.userId || "—";
      } catch (e) { console.warn("getProfile 失敗", e); }
    }

    async function initLiff() {
      $("#status").textContent = "呼叫 liff.init()…";
      await liff.init({ liffId: LIFF_ID });                         // 每次開頁都要 init
      const ok = await ensureLogin(); if (!ok) return false;        // 確保登入
      $("#status").textContent = liff.isInClient() ? "已在 LINE 內開啟" : "外部瀏覽器開啟";
      await loadProfile();
      return true;
    }

    // 送單
    $("#orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = $("#submitMsg");
      const btn = $("#submitBtn");
      msg.className = "muted"; msg.textContent = "送出中…"; btn.disabled = true;

      try {
        const inited = await initLiff(); if (!inited) return;
        const idToken = liff.getIDToken();                          // 需 openid scope
        if (!idToken) throw new Error("取不到 id_token：請以 LIFF URL 開啟並登入");

        // 收集欄位 → x-www-form-urlencoded（simple request，跨網域最穩）
        const fd = new FormData(e.target);
        const p = new URLSearchParams();
        p.set("id_token", idToken);
        ["customerName","address","phone","orderDate","startTime","endTime","qty","note"]
          .forEach(k => p.set(k, (fd.get(k) || "").toString().trim()));

        const res  = await fetch(GAS_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: p.toString()
        });

        let json = {}; try { json = await res.json(); } catch {}
        if (!res.ok || !json.ok) throw new Error(json.message || `HTTP ${res.status}`);

        msg.className = "ok"; msg.textContent = `已送出 ✅ 訂單編號：${json.orderId}`;
        e.target.reset();
      } catch (err) {
        console.error(err);
        msg.className = "err"; msg.textContent = "❌ " + (err?.message || err);
      } finally {
        btn.disabled = false;
      }
    });

    $("#refreshBtn").addEventListener("click", loadProfile);
    $("#logoutBtn").addEventListener("click", () => { if (liff.isLoggedIn()) { liff.logout(); location.reload(); }});

    prefillFromQuery();
    (async () => { try { await initLiff(); } catch (e) { console.error(e); }})();
  </script>
</body>
</html>

