<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‰æ©å†°å¡Š è¨‚å–®è¡¨å–®</title>
  <style>
    :root {
      --bd:#e5e7eb; --info:#f8fafc; --info-bd:#cbd5e1;
      --primary:#111827;              /* ä¸»è‰²ï¼šè¿‘é»‘ */
      --primary-contrast:#fff;
      --ok-bg:#d1fae5; --ok-bd:#10b981; --ok-fg:#065f46;
    }
    body { font-family: system-ui, -apple-system, "Noto Sans TC", Arial; margin:0; background:#fff; }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    h1 { font-size:28px; margin:0 0 16px; }
    h2 { font-size:20px; margin:0 0 12px; }
    .card { border:1px solid var(--bd); border-radius:14px; padding:16px; background:#fff; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    label { display:block; font-size:14px; color:#111827; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    textarea { resize:vertical; }
    .help { color:#6b7280; font-size:12px; display:block; margin-top:4px; }
    .error { color:#b42318; font-size:13px; margin-top:8px; }
    .muted { color:#6b7280; font-size:13px; }
    .mt { margin-top:20px; }
    .notice { background:var(--info); border:1px solid var(--info-bd); color:#334155; padding:10px 14px; border-radius:12px; margin:0 0 16px; }

    .row { margin:8px 0; }

    .btn, input[type="submit"], input[type="reset"], button {
      color:#111827 !important; -webkit-text-fill-color:#111827 !important;
      background:#fff; border:1px solid var(--bd); font-size:16px; line-height:1.2; border-radius:10px; padding:10px 14px;
      -webkit-appearance:none; appearance:none; cursor:pointer;
      transition: transform .02s ease, box-shadow .2s ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary {
      background: var(--primary); color: var(--primary-contrast) !important; -webkit-text-fill-color: var(--primary-contrast) !important;
      border:1px solid var(--primary); box-shadow:0 6px 18px rgba(17,24,39,.15); font-weight:600;
    }
    .btn-primary:disabled { opacity:.6; cursor:not-allowed; box-shadow:none; }

    .seg { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .seg .opt {
      border:2px solid var(--bd); border-radius:12px; padding:10px 14px; cursor:pointer; user-select:none;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .seg .opt[aria-pressed="true"] { border-color:var(--primary); box-shadow:0 0 0 3px rgba(17,24,39,.12); font-weight:600; }
    .seg .opt[aria-disabled="true"] { opacity:.45; cursor:not-allowed; }

    /* æˆåŠŸæç¤º Toast */
    .toast {
      position:fixed; inset:auto 16px 16px 16px;
      background:var(--ok-bg); border:1px solid var(--ok-bd); color:var(--ok-fg);
      padding:10px 14px; border-radius:12px; font-size:14px; display:none;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    .toast.show { display:block; animation:fadein .18s ease; }
    @keyframes fadein { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="notice">
      <b>é…é€æ™‚æ®µï¼š</b>ä¸Šåˆ 08:00â€“12:00ï¼›ä¸‹åˆ 15:00â€“17:00ã€‚
      <span class="muted">ï¼ˆä¾ä¸‹å–®æ™‚é–“è‡ªå‹•é™åˆ¶å¯é ç´„çš„æ—¥æœŸèˆ‡æ™‚æ®µï¼‰</span>
    </div>

    <h1>å‰æ©å†°å¡Š è¨‚å–®è¡¨å–®</h1>

    <form id="orderForm" class="card mt" autocomplete="on">
      <h2>è¨‚è³¼è³‡æ–™</h2>
      <div class="grid">
        <div>
          <label>å®¢æˆ¶/åº—å®¶åç¨±
            <input name="customerName" required placeholder="é˜¿ç¶¸ç†±ç‚’/å°éƒ­é£²æ–™åº—">
          </label>
        </div>
        <div>
          <label>å¤–é€åœ°å€
            <input name="address" required placeholder="æ–°åŒ—å¸‚ä¸‰é‡å€â—‹â—‹è·¯ 1 è™Ÿ">
          </label>
        </div>
        <div>
          <label>é›»è©±/æ‰‹æ©Ÿ
            <input name="phone" required inputmode="tel" placeholder="0912-345-678">
          </label>
        </div>
        <div>
          <label>é å®šæ—¥æœŸ
            <input type="date" name="orderDate" required>
            <small class="help" id="dateHelp"></small>
          </label>
        </div>

        <!-- AM/PM é¸æ“‡ -->
        <div>
          <label>é¸æ“‡é…é€æ™‚æ®µ</label>
          <div class="seg" role="group" aria-label="é…é€æ™‚æ®µ">
            <div id="optAM"  class="opt" role="button" aria-pressed="false">ä¸Šåˆï¼ˆ08:00â€“12:00ï¼‰</div>
            <div id="optPM"  class="opt" role="button" aria-pressed="false">ä¸‹åˆï¼ˆ15:00â€“17:00ï¼‰</div>
          </div>
          <div id="slotErr" class="error" style="display:none"></div>
        </div>

        <div>
          <label>è¨‚è³¼æ•¸é‡ï¼ˆæ•´æ•¸ï¼‰
            <input type="number" name="qty" min="1" max="10" step="1" required placeholder="ä¾‹å¦‚ 2">
            <small class="help">æœ€å¤š 10 åŒ…</small>
          </label>
        </div>

        <div>
          <label>å‚™è¨»
            <textarea name="note" rows="3" placeholder="ï¼ˆå¹¾é»æœ‰äººåœ¨? è«‹å‘ŠçŸ¥ï¼Œæˆ–å…¶å®ƒæé†’ç¤ºé …ï¼‰"></textarea>
          </label>
        </div>
      </div>

      <!-- éš±è—æ¬„ä½é€å¾Œç«¯ -->
      <input type="hidden" name="startTime">
      <input type="hidden" name="endTime">
      <input type="hidden" name="slot">

      <div class="row mt" style="display:flex; align-items:center; gap:10px;">
        <input id="submitBtn" type="submit" value="é€å‡º" class="btn btn-primary" style="min-width:140px">
        <input id="resetBtn"  type="reset"  value="æ¸…ç©º" class="btn">
        <span id="submitMsg" class="muted"></span>
      </div>
    </form>
  </div>

  <!-- æˆåŠŸæç¤º -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /* ====================  ğŸ”§ éœ€æ›¿æ›ç‚ºã€Œæ­£å¼å€¼ã€  ==================== */
    const LIFF_ID = "2008199393-NjOGJm4P";              // â† æ”¹æˆæ­£å¼ LIFF_ID
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyPFJLb4cGMELLljDXB5-Pl6fEg_doulaksba1p6hHAGvqcv1WYGa3Mr7yUQoYPAYDGKw/exec"; // â† æ”¹æˆæ­£å¼ Apps Script /exec
    /* =============================================================== */

    // æ™‚æ®µå®šç¾©
    const AM = { key:"AM", start:"08:00", end:"12:00" };
    const PM = { key:"PM", start:"15:00", end:"17:00" };

    const $ = (s)=>document.querySelector(s);
    const byName = (n)=>document.querySelector(`[name="${n}"]`);

    function todayISO(d = new Date()) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2, "0");
      const da = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${da}`;
    }

    function computeAllowed() {
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      const TODAY = todayISO(now);
      const TOMORROW = todayISO(new Date(now.getTime() + 24*60*60*1000));

      let minDate = TODAY;
      let allowToday = true;
      let allowAM = true;
      let allowPM = true;
      let note = "";

      if (nowMin >= 13*60) {
        // 13:00 ä»¥å¾Œ â†’ ä»Šæ—¥ä¸å¯ä¸‹å–®ï¼Œæœ€æ—©ç‚ºæ˜å¤©
        minDate = TOMORROW;
        allowToday = false;
        note = "ç¾åœ¨å·²é 13:00ï¼Œæœ€æ—©å¯é ç´„ç‚ºæ˜æ—¥";
      } else if (nowMin >= 7*60 && nowMin < 13*60) {
        // 07:00â€“12:59 â†’ ä»Šæ—¥åƒ…èƒ½é ç´„ ä¸‹åˆ (PM)
        allowAM = false;
        allowPM = true;
        note = "ä»Šå¤©åƒ…å¯é ç´„ã€Œä¸‹åˆ (15:00â€“17:00)ã€";
      } else {
        // 00:00â€“06:59 â†’ ä»Šå¤©å¯é ç´„ ä¸Šåˆæˆ–ä¸‹åˆ
        allowAM = true;
        allowPM = true;
        note = "ä»Šå¤©å¯é ç´„ã€Œä¸Šåˆæˆ–ä¸‹åˆã€";
      }

      return { minDate, allowToday, allowAM, allowPM, note };
    }

    function refreshDateAndSlot() {
      const dateInput = byName("orderDate");
      const optAM = $("#optAM"), optPM = $("#optPM");
      const dateHelp = $("#dateHelp");
      const allow = computeAllowed();

      dateInput.min = allow.minDate;
      if (!dateInput.value || dateInput.value < allow.minDate) {
        dateInput.value = allow.minDate;
      }

      if (!allow.allowAM) {
        optAM.setAttribute("aria-disabled", "true");
        optAM.style.opacity = .45;
        optAM.style.pointerEvents = "none";
      } else {
        optAM.setAttribute("aria-disabled", "false");
        optAM.style.opacity = 1;
        optAM.style.pointerEvents = "";
      }
      if (!allow.allowPM) {
        optPM.setAttribute("aria-disabled", "true");
        optPM.style.opacity = .45;
        optPM.style.pointerEvents = "none";
      } else {
        optPM.setAttribute("aria-disabled", "false");
        optPM.style.opacity = 1;
        optPM.style.pointerEvents = "";
      }

      if (!allow.allowToday && dateInput.value === allow.minDate) {
        // å¦‚æœä»Šå¤©ä¸å¯ï¼Œä½† date è¢«è¨­å®šæˆä»Šå¤© â†’ æ”¹ç‚ºæ˜å¤©
        dateInput.value = allow.minDate;
      }

      dateHelp.textContent = allow.note;

      // è‡ªå‹•é è¨­ slot
      if (allow.allowAM) {
        setSlot(AM.key);
      } else if (allow.allowPM) {
        setSlot(PM.key);
      } else {
        setSlot(null);
      }
    }

    // slot æ§åˆ¶ (èˆ‡ä½ åŸæœ¬ä¸€æ¨£)
    const optAM = $("#optAM"), optPM = $("#optPM");
    function setSlot(slot){
      const st=byName("startTime"), et=byName("endTime"), sl=byName("slot");
      if (slot===AM.key){ st.value=AM.start; et.value=AM.end; sl.value=AM.key; optAM.setAttribute("aria-pressed","true"); optPM.setAttribute("aria-pressed","false"); }
      else if (slot===PM.key){ st.value=PM.start; et.value=PM.end; sl.value=PM.key; optAM.setAttribute("aria-pressed","false"); optPM.setAttribute("aria-pressed","true"); }
      else { st.value=et.value=sl.value=""; optAM.setAttribute("aria-pressed","false"); optPM.setAttribute("aria-pressed","false"); }
    }

    // LIFF åˆå§‹åŒ– etc. å…¶é¤˜ code ä¿æŒä¸è®Š...
    async function initLiff(){
      try{
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login({ redirectUri: window.location.href }); return; }
        window.LIFF_READY = true;
        try{
          const p = await liff.getProfile();
          window.__USER_ID__ = p.userId || "";
          if (window.__USER_ID__) {
            // è¼‰å…¥é è¨­è³‡æ–™ (è‹¥æœ‰)
            try{
              const raw = localStorage.getItem(`liff:defaults:v2:${window.__USER_ID__}`);
              if (raw) {
                const d = JSON.parse(raw);
                if (d.customerName && !byName("customerName").value) byName("customerName").value = d.customerName;
                if (d.address && !byName("address").value) byName("address").value = d.address;
                if (d.phone && !byName("phone").value) byName("phone").value = d.phone;
                if (d.note && !byName("note").value) byName("note").value = d.note;
              }
            } catch {}
          }
        } catch(e){}
      } catch(e){ console.error("liff.init å¤±æ•—", e); }
    }

    // ç•¶é é¢ load åŠ orderDate æ”¹è®Šæ™‚ï¼ŒåŸ·è¡Œ refresh
    window.addEventListener("load", async () => {
      await initLiff();
      refreshDateAndSlot();
    });
    byName("orderDate").addEventListener("change", refreshDateAndSlot);

    optAM.addEventListener("click", () => { if (optAM.getAttribute("aria-disabled")==="true") return; setSlot(AM.key); $("#slotErr").style.display="none"; });
    optPM.addEventListener("click", () => { if (optPM.getAttribute("aria-disabled")==="true") return; setSlot(PM.key); $("#slotErr").style.display="none"; });

    // è¡¨å–®é€å‡º & submit logic ä¿æŒä½ åŸæœ¬
    $("#orderForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const btn=$("#submitBtn"), msg=$("#submitMsg");
      msg.className="muted"; msg.textContent="é€å‡ºä¸­â€¦"; btn.disabled=true;

      refreshDateAndSlot();

      if (!byName("slot").value) {
        $("#slotErr").style.display="block"; $("#slotErr").textContent="è«‹é¸æ“‡å¯é ç´„çš„æ™‚æ®µï¼ˆä¸Šåˆæˆ–ä¸‹åˆï¼‰";
        btn.disabled=false; return;
      }
      const qtyVal = parseInt(byName("qty").value, 10);
      if (isNaN(qtyVal) || qtyVal<1 || qtyVal>10) { msg.className="error"; msg.textContent="âŒ æ•¸é‡å¿…é ˆæ˜¯ 1ï½10 ä¹‹é–“çš„æ•´æ•¸"; btn.disabled=false; return; }

      if (!window.LIFF_READY || !liff.isLoggedIn()) { msg.className="error"; msg.textContent="âŒ LIFF å°šæœªå°±ç·’æˆ–æœªç™»å…¥"; btn.disabled=false; return; }
      const idToken = liff.getIDToken();
      if (!idToken) { msg.className="error"; msg.textContent="âŒ å–ä¸åˆ° ID Token"; btn.disabled=false; return; }

      try{
        const fd=new FormData(e.target);
        const p=new URLSearchParams();
        p.set("id_token", idToken);
        ["customerName","address","phone","orderDate","startTime","endTime","qty","note","slot"]
          .forEach(k=>p.set(k,(fd.get(k)||"").toString().trim()));

        const controller=new AbortController(); const timer=setTimeout(()=>controller.abort(),15000);
        const res=await fetch(GAS_ENDPOINT,{ method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" }, body:p.toString(), signal:controller.signal })
          .catch(err=>{ throw new Error(err.name==="AbortError"?"é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦":err.message); });
        clearTimeout(timer);

        let json={}; try{ json=await res.json(); }catch{}
        if(!res.ok || !json.ok) throw new Error(json.message||`HTTP ${res.status}`);

        if (window.__USER_ID__) {
          try {
            const data = {
              customerName: byName("customerName").value.trim(),
              address: byName("address").value.trim(),
              phone: byName("phone").value.trim(),
              note: byName("note").value.trim(),
            };
            localStorage.setItem(`liff:defaults:v2:${window.__USER_ID__}`, JSON.stringify(data));
          } catch {}
        }

        msg.className="muted"; msg.textContent="";
        const toast = $("#toast");
        toast.textContent = `å·²é€å‡º âœ… è¨‚å–®ç·¨è™Ÿï¼š${json.orderId}`;
        toast.classList.add("show");
        setTimeout(()=>toast.classList.remove("show"), 3200);
        e.target.reset();
        refreshDateAndSlot();
      }catch(err){
        console.error(err); msg.className="error"; msg.textContent="âŒ "+(err?.message||err);
      }finally{ btn.disabled=false; }
    });
  </script>
</body>
</html>
